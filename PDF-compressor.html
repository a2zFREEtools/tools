<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>PDFCompressPro (Fixed)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#1d4ed8; color:#fff; text-align:center; }
    .container { max-width:800px;margin:20px auto;background:#fff;color:#111;padding:20px;border-radius:12px }
    .btn { background:#2563eb;color:#fff;border:none;padding:10px 20px;margin-top:10px;border-radius:8px;cursor:pointer }
    .btn:hover{background:#1e40af}
  </style>
</head>
<body>
  <h1>PDFCompressPro</h1>
  <p>Simulated PDF Compression (Now Opens Correctly)</p>

  <div class="container">
    <input type="file" id="upload" accept="application/pdf" />
    <p id="fileName"></p>

    <label for="compression">Compression Level: <span id="value">50%</span></label>
    <input type="range" id="compression" min="10" max="100" value="50">

    <p>Original: <span id="originalSize">--</span></p>
    <p>Compressed: <span id="compressedSize">--</span></p>

    <button class="btn" id="compressBtn">Compress PDF</button>
    <a id="downloadLink" class="btn" style="display:none;margin-top:15px" download>Download</a>
  </div>

  <script>
    const compression = document.getElementById('compression');
    const value = document.getElementById('value');
    const upload = document.getElementById('upload');
    const fileName = document.getElementById('fileName');
    const originalSizeEl = document.getElementById('originalSize');
    const compressedSizeEl = document.getElementById('compressedSize');
    const compressBtn = document.getElementById('compressBtn');
    const downloadLink = document.getElementById('downloadLink');

    let originalFileSize = 0;
    let originalFileName = 'file.pdf';
    let currentObjectUrl = null;

    compression.addEventListener('input', () => {
      value.textContent = compression.value + '%';
    });

    upload.addEventListener('change', () => {
      if (upload.files.length > 0) {
        const file = upload.files[0];
        originalFileName = file.name;
        fileName.textContent = "Selected: " + originalFileName;
        originalFileSize = file.size;
        originalSizeEl.textContent = (originalFileSize / 1024 / 1024).toFixed(2) + " MB";
        compressedSizeEl.textContent = "--";
        downloadLink.style.display = 'none';
      }
    });

    function createValidPdf(targetBytes) {
      // बेसिक मिनिमल वैलिड PDF (1 पेज, टेक्स्ट "Hello PDF")
      const header = "%PDF-1.4\n";
      const obj1 = "1 0 obj <</Type/Catalog/Pages 2 0 R>> endobj\n";
      const obj2 = "2 0 obj <</Type/Pages/Count 1/Kids[3 0 R]>> endobj\n";
      const obj3 = "3 0 obj <</Type/Page/Parent 2 0 R/MediaBox[0 0 200 200]/Contents 4 0 R/Resources<</Font<</F1 5 0 R>>>>>> endobj\n";
      const streamContent = "BT /F1 24 Tf 50 150 Td (Hello PDF) Tj ET ";
      
      // Padding inside stream
      let padding = "X".repeat(Math.max(0, targetBytes - 600)); 
      const obj4 = `4 0 obj <</Length ${streamContent.length + padding.length}>> stream\n${streamContent}${padding}\nendstream endobj\n`;
      const obj5 = "5 0 obj <</Type/Font/Subtype/Type1/BaseFont/Helvetica>> endobj\n";
      
      let body = obj1 + obj2 + obj3 + obj4 + obj5;
      let xrefOffset = header.length + body.length;
      const xref = `xref\n0 6\n0000000000 65535 f \n0000000010 00000 n \n0000000060 00000 n \n0000000120 00000 n \n0000000200 00000 n \n0000000400 00000 n \n`;
      const trailer = "trailer <</Root 1 0 R/Size 6>>\n";
      const startxref = "startxref\n" + xrefOffset + "\n%%EOF";

      return new Blob([header + body + xref + trailer + startxref], { type: "application/pdf" });
    }

    compressBtn.addEventListener('click', () => {
      if (!originalFileSize) {
        alert("Please select a PDF first!");
        return;
      }
      const sliderValue = Number(compression.value);
      const minBytes = 100 * 1024; // 100 KB
      const maxBytes = originalFileSize;
      const t = (sliderValue - 10) / 90;
      const targetBytes = Math.max(minBytes, Math.round(minBytes + t * (maxBytes - minBytes)));

      compressedSizeEl.textContent = (targetBytes / 1024 / 1024).toFixed(2) + " MB";

      if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);

      const blob = createValidPdf(targetBytes);
      currentObjectUrl = URL.createObjectURL(blob);

      const dotIndex = originalFileName.lastIndexOf('.');
      const baseName = dotIndex > 0 ? originalFileName.slice(0, dotIndex) : originalFileName;
      downloadLink.download = baseName + "-compressed.pdf";
      downloadLink.href = currentObjectUrl;
      downloadLink.style.display = 'inline-block';
    });
  </script>
</body>
</html>
